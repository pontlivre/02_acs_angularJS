# 第２回：コントローラとスコープ

AngularJSは HTMLベースのテンプレートエンジンを採用しており、以下の３つの機能があると前回、軽く説明しました。

* エクスプレッション
* ディレクティブ
* 双方向バインディング	

今回はテンプレートとJavaScriptコードを結びつける **コントローラ** と **スコープ ** について説明します。

スコープはテンプレートに公開するプロパティやメソッド(関数)を定義するオブジェクトで、
コントローラは、スコープオブジェクトをセットアップするオブジェクトです。

例えば、画面の初期値やボタン押下時の処理などの複雑な処理は、コントローラ内でスコープに対してセットアップし、テンプレートでそれらを参照、実行して画面の振る舞いを実装します。

以下の図は、AngularJSにおけるMVCパターンでの **プレゼンテーション層(View)** と **ドメイン層(Model) ** の関係を図解化したものです。コントローラとスコープは、赤の点線の部分の役割を担います。

----

### 図1 AngularJSにおけるMVC構成とその役割

![AngularJSにおけるMVC構成とその役割](./images/sample02_1.png)

`↑初めてGoogle ドキュメントを使ってみましたが、
ブラウザだけでここまで書けるとOffice製品はいらないですね・・・。`

----


## スコープとコントローラの利用方法

コントローラを使うには、まずテンプレートファイルの何処から何処までをコントローラで処理するかという **「範囲」** を指定します。  
テンプレートファイルでコントローラが扱う範囲を指定するには、_ng-contoroller_ ディレクティブを使用します。	

```html
&lt;html ng-app="app">
  ...
&lt;div ng-controller="Sample02Ctrl">
&lt;/div>
  ...
&lt;/html>
```

次に JavaScript で _ng-controller_ で指定したコントローラを定義します。
_ng-controller_ で指定可能なコントローラは _Module#controller_ メソッドを利用します。

```js
angular.module('app', [])
    .controller('Sample02Ctrl', ['$scope', function($scope){
        /* ここにロジックを書く */
    }]);
```

1行目で _angular.module_ メソッドを使用して _Module_ を作成しています。
第１引数はモジュール名で、_ng-app_ ディレクティブで指定した名前を指定します。
第２引数は、このモジュールで必要な他のモジュール名を配列で指定します。今回は他のモジュールは使用しないため空の配列を指定しています。

2行目では、_Module_ オブジェクトに対して 'Sample02Ctrl' という名前のコントローラを登録しています。
このメソッドも引数を２つ取りますが、ここではスコープを使う場合は、上記のように書くとだけ覚えておいてください。後日、DI機能について説明するときに詳しく解説したいと思います。

第１引数は、コントローラの処理は、_function($scope) { ... }_ の中に記述します。  
functionの引数として、スコープ($scope)が渡されるので、コントローラでは $scope に対してプロパティを定義したり、メソッドを定義したりします。
ちなみに、変数名に **$** が付いているものは、AngularJSで用意されているオブジェクトです。

## コントローラの実装

それでは、実際に以下の使用をコントローラを使って実装してみましょう。

* 初期表示したときに "Hello World" と表示する
* ボタンをクリックすると "Hello World" を "Goodby Everyone" に変更する

```js
angular.module('app', [])
    .controller('Sample02Ctrl', ['$scope', function($scope){
        $scope.message = 'Hello World';
        $scope.sayGoodbye = function() {
            $scope.message = 'Goodby Everyon';
        };
    }]);
```

初期表示時に "Hello World" と表示したいので、スコープに _message_ というプロパティを定義し、初期値として "Hello World" を設定します。
これで、テンプレートからは、_message_ という名前でこの値にアクセスすることが出来ます。

次に ボタンクリック時に実行するメソッドは _function_ をスコープに設定すればOKです。
ここでは、_sayGoodbye_ という名前で定義しました。

それでは、次にHTMLを書いてみましょう。
スコープの _message_ プロパティと、クリックしたら _sayGoodbye_ を実行するボタンを配置するだけですね。

```html
&lt;div ng-controller="Sample02Ctrl">
    &lt;p>{{message}}&lt;/p>
    &lt;button ng-click="sayGoodbye()">push me!&lt;/button>
&lt;/div>
```

2行目でエクスプレッションを用いて _message_ の内容を表示しています。
3行目は、_ng-click_ ディレクティブを使ってボタンクリック時の振る舞いを定義しています。  
HTMLでのイベントに対応した各ディレクティブがビルトインされているので、それらを使ってスコープ内のプロパティやメソッドにアクセスします。  
ちなみにエクスプレッションで出力した値は、サニタイズされますのセキュリティ的にも安全です。

実際の動作は、サンプルタブ で確認できます。

## 今回のまとめ

### スコープの役割

スコープはテンプレートに対して公開するプロパティやメソッドを定義するオブジェクトです。  
AngularJSが登場する以前では、jQueryなどを使ってロジックで直接HTML(DOM)を書き換えたり、イベントのハンドリングが必要でした。
そして、HTML構造の変更に伴って、DOM操作の修正も必要になるのでメンテナンス性も低下し、描画には必要のない id や class を付与する作業が必要でした。

一方、AngularJSでは、DOM と JavaScript の間にこの **スコープ** が用意されています。スコープの内容の変化はフレームワークに監視されており、スコープの値が変化すると、その変更内容が DOM に反映されます。

また、DOMイベントが発生した場合は対応するスコープのメソッドが呼び出されます。  
このような複雑なDOM操作を AngularJS が隠蔽してくれているので、開発ではスコープに対する操作をするだけで、描画内容を変更でき、メンテナンス性の高いコードを記述できます。

### コントローラの役割

コントローラは、スコープの値をセットアップするオブジェクトです。
今回は、単純なセットアップ操作であるためロジックはコントローラに書きましたが、実際に開発で使用する場合には、サービスに分離して記述し、コントローラはあくまでスコープのセットアップ処理だけを行うのが理想的とされています。











